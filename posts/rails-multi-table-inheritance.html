<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" type="image/png" href="/assets/favicon.png">

  <title>Rails Multi Table Inheritance</title>
  <meta name="description" content="The Actual ProblemI have different kinds of questionaires to build, but these questionaires have some parts in common. Therefore, I want to extract out these...">

  <link rel="stylesheet" href="/css/main.css">
  <link rel="canonical" href="https://songyangyu.com/posts/rails-multi-table-inheritance.html">
  <link rel="alternate" type="application/rss+xml" title="Yangyu's Notes" href="https://songyangyu.com/feed.xml">
  
</head>


  <body>
    

    <header class="site-header">

  <div class="wrapper">

    <a class="site-title" href="/">Yangyu's Notes</a>

    <nav class="site-nav">
      <a href="#" class="menu-icon">
        <svg viewBox="0 0 18 15">
          <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"/>
          <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"/>
          <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"/>
        </svg>
      </a>

      <div class="trigger">
        <a class="page-link" href="/about">About</a>
      </div>
    </nav>

  </div>

</header>


    <div class="page-content">
      <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title" itemprop="name headline">Rails Multi Table Inheritance</h1>
    <p class="post-meta">
      <time datetime="2014-01-20T00:00:00+08:00" itemprop="datePublished">Jan 20, 2014</time>
      
      
      <span>rails</span>
      
      <span>technique</span>
      
    </p>
  </header>

  <div class="post-content" itemprop="articleBody">
    <h2 id="the-actual-problem">The Actual Problem</h2>
<p>I have different kinds of questionaires to build, but these questionaires have some parts in common. Therefore, I want to extract out these common parts, so that I can:</p>

<ul>
  <li>Build the common parts at one place when rendering</li>
  <li>Put in some common functionality to my questionaires. For example, do user verification before starting the questionaire.</li>
  <li>Have one place to list all different kinds of questionaires, and by clicking them, I can go&amp;visit each different questionaire.</li>
</ul>

<h2 id="the-abstracted-problem">The Abstracted Problem</h2>
<p>I can have a base type, which contains the common informaiton about these questionaires; then for whatever questionaire I am adding in, I should be able to extend from that base questionaire type, therefore automatically have these common behaviours &amp; common properties</p>

<p>When I save it into the database, the structure should be something like this:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>BaseTable
- name
- age
...

| TennisQuestionaireTable
- base_id
- tennis_ball_num
- ...

| PingPangnQuestionaireTable
- base_id
- pingpang_player_name
- ...
</code></pre></div></div>

<h2 id="the-single-table-inheritance">The Single Table Inheritance</h2>
<p>Rails has the Single-Table-Inheritance(STI) implemented: simply by adding the ‘type’ into the actual database table. <a href="http://eewang.github.io/blog/2013/03/12/how-and-when-to-use-single-table-inheritance-in-rails/">This post</a> has nicely summarized what is STI and how&amp;why to use it. Let me paraphrase it a bit here (not quote from the blog post):</p>

<blockquote>
  <p>You have multiple models, but all are referring to the same table. The ‘type’ in that table tells which model would take control of this record. 
By having multiple model upon a single table, one can get more control over each different model types.</p>
</blockquote>

<p>I personally see very little use of this STI mechanism: usually, if the model is different, then the corresponding database structure is likely to be different also (like here in my use case of questionaire).</p>

<h2 id="the-multi-table-inheritance">The Multi Table Inheritance</h2>
<p>I would define the multi-table-inheritance(MTI) this way:</p>

<blockquote>
  <p>You have a parent model, and you have several child models which inheritant from the parent model.
Each model has their own table; although the child table don’t have the fields in the parent table, the
child model can still use the records in the parent’s table, as if these fields exist in the child table.
When these fields are updated by the child table, they’re updated in the parent table accordingly.
More-over, one can get all the childrens of a parent, by simply querying upon the parent table.</p>
</blockquote>

<p>Rails don’t have a native support for the MTI, therefore I need to implement my own. Here is how I implemented</p>

<p>Firstly, the base table. This defines the structure of the basic model, and other extending models would also extend
form a module of this base table.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># File: app/models/base_table.rb</span>
<span class="k">class</span> <span class="nc">BaseTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">module</span> <span class="nn">BaseTableInclude</span>
    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">included</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
      <span class="n">base</span><span class="p">.</span><span class="nf">belongs_to</span> <span class="ss">:base_table</span><span class="p">,</span> <span class="n">autosave</span><span class="ss">:true</span><span class="p">,</span> <span class="ss">dependent: :destroy</span>
      <span class="n">base</span><span class="p">.</span><span class="nf">before_validation</span> <span class="nb">proc</span><span class="p">{</span> <span class="nb">self</span><span class="p">.</span><span class="nf">base_table</span><span class="p">.</span><span class="nf">qtype</span> <span class="o">=</span> <span class="nb">self</span><span class="p">.</span><span class="nf">class</span><span class="p">.</span><span class="nf">to_s</span><span class="p">}</span>
      <span class="n">base</span><span class="p">.</span><span class="nf">after_initialize</span> <span class="nb">proc</span><span class="p">{</span><span class="nb">self</span><span class="p">.</span><span class="nf">base_table</span> <span class="o">=</span> <span class="no">BaseTable</span><span class="p">.</span><span class="nf">new</span> <span class="k">unless</span> <span class="nb">self</span><span class="p">.</span><span class="nf">base_table</span><span class="p">}</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Correspondingly, in my extended model, I have the vary simple structure below:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># File: app/models/tennis_questionaire.rb</span>
<span class="k">class</span> <span class="nc">TennisQuestionaire</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">BaseTable</span><span class="o">::</span><span class="no">BaseTableInclude</span>
<span class="k">end</span></code></pre></figure>

<p>The extended model would just stay simple, we’ll adding more methods in the base models to fully support the MTI.</p>

<p>Firstly, I want to be able to access the property of the base table, just like accessing the properties of my extended table. To make it short, I want functions like method below:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">t</span> <span class="o">=</span> <span class="no">TennisQuestionaire</span><span class="p">.</span><span class="nf">new</span>
<span class="n">t</span><span class="p">.</span><span class="nf">name</span> <span class="o">=</span> <span class="s2">"Songyy"</span>
<span class="n">t</span><span class="p">.</span><span class="nf">save</span></code></pre></figure>

<p>This is done using a method_missing overiding, to delegate the missing method to the base_table if cannot find in
the extended table:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">BaseTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">module</span> <span class="nn">BaseTableInclude</span>
    <span class="k">def</span> <span class="nf">method_missing</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">base_table</span><span class="p">.</span><span class="nf">respond_to?</span><span class="p">(</span><span class="nb">method</span><span class="p">)</span>
        <span class="n">base_table</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="nb">method</span><span class="p">,</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">blk</span><span class="p">)</span>
      <span class="k">else</span>
        <span class="k">super</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Secondly, I want to be able to get instance of the extended table, from the base table. This is done by saving the name of the extended_table:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">BaseTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">def</span> <span class="nf">get_extend_form</span>
    <span class="nb">self</span><span class="p">.</span><span class="nf">qtype</span><span class="p">.</span><span class="nf">constantize</span><span class="p">.</span><span class="nf">find_by</span><span class="p">(</span><span class="n">base_table_id</span><span class="ss">:self</span><span class="p">.</span><span class="nf">id</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>In order to use it properly in the controller, esp. the methods of:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="n">t</span> <span class="o">=</span> <span class="no">TennisQuestionaire</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
<span class="n">t</span><span class="p">.</span><span class="nf">save</span>
<span class="n">t</span><span class="p">.</span><span class="nf">update</span><span class="p">(</span><span class="n">params</span><span class="p">)</span></code></pre></figure>

<p>to be used in the controller, I need to override the <code class="language-plaintext highlighter-rouge">initialize</code> and <code class="language-plaintext highlighter-rouge">update</code> methods.</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="k">class</span> <span class="nc">BaseTable</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="k">module</span> <span class="nn">BaseTableInclude</span>
    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">handle_res</span> <span class="o">=</span> <span class="n">handle_param_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="p">{</span> <span class="o">|</span><span class="n">params</span><span class="o">|</span> <span class="n">params</span><span class="p">[</span><span class="ss">:base_table</span><span class="p">]</span> <span class="o">=</span> <span class="no">BaseTable</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="ss">:base_table</span><span class="p">])</span> <span class="p">}</span>
      <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
      <span class="n">handle_res</span> <span class="o">=</span> <span class="n">handle_param_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">params</span><span class="o">|</span>
        <span class="n">params</span><span class="p">[</span><span class="ss">:base_table</span><span class="p">].</span><span class="nf">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">k</span><span class="p">,</span><span class="n">v</span><span class="o">|</span> <span class="nb">self</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="s2">"</span><span class="si">#{</span><span class="n">k</span><span class="si">}</span><span class="s2">="</span><span class="p">,</span><span class="n">v</span><span class="p">)</span> <span class="p">}</span>
        <span class="n">params</span><span class="p">.</span><span class="nf">except!</span> <span class="ss">:base_table</span>
      <span class="k">end</span>
      
      <span class="k">super</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span><span class="o">&amp;</span><span class="n">block</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">private</span> 
    <span class="k">def</span> <span class="nf">handle_param_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
      <span class="k">return</span> <span class="k">unless</span> <span class="nb">block_given?</span>

      <span class="k">if</span> <span class="n">args</span><span class="p">.</span><span class="nf">length</span> <span class="o">&gt;</span> <span class="mi">0</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="p">.</span><span class="nf">is_a?</span> <span class="no">Hash</span><span class="p">)</span> <span class="n">and</span> <span class="n">params</span><span class="p">[</span><span class="ss">:base_table</span><span class="p">].</span><span class="nf">is_a?</span> <span class="no">Hash</span>
          <span class="k">yield</span> <span class="n">params</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Up to this point here, the model has been very-much defined to support MTI, and it’s pretty clean – if one needs to
create a new extended model, all one needs to do is to do:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># File: app/models/extended_model.rb</span>
<span class="k">class</span> <span class="nc">ExtendedModel</span> <span class="o">&lt;</span> <span class="no">ActiveRecord</span><span class="o">::</span><span class="no">Base</span>
  <span class="kp">include</span> <span class="no">BaseTable</span><span class="o">::</span><span class="no">BaseTableInclude</span>
<span class="k">end</span></code></pre></figure>

<p>and that’s all.</p>

<p>Now we need to change the controller part, which is a bit.. messy.</p>

<p>Firstly, we would extend from the BaseController, and in the filtering of the params, permit the base_table:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># File: app/controllers/tennis_questionaires_controller.rb</span>
<span class="k">class</span> <span class="nc">TennisQuestionairesController</span> <span class="o">&lt;</span> <span class="no">BaseController</span>
  <span class="c1"># ... other code ...</span>
<span class="kp">private</span>
  <span class="k">def</span> <span class="nf">tennis_questionaire_params</span>
    <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:tennis_questionaire</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="ss">:tennis_ball_num</span><span class="p">,</span><span class="n">base_table</span><span class="ss">:base_table_properties</span><span class="p">)</span>
  <span class="k">end</span>
  <span class="k">def</span> <span class="nf">extended_name</span><span class="p">;</span> <span class="ss">:tennis_questionaire</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>This is a bit unclean because it requires some actual changes, in a deep location, to the code to use the MTI.
But that’s the only method I can come up with.</p>

<p>The <code class="language-plaintext highlighter-rouge">base_table_properties</code> is defined in the <code class="language-plaintext highlighter-rouge">BaseController</code>; it also defines the <code class="language-plaintext highlighter-rouge">update_param</code> to pre-process
the params passed-in. The extended_name is the one to pass to the BaseController, so that it knows which key of 
the params to set. Here’s hte <code class="language-plaintext highlighter-rouge">BaseController</code> class:</p>

<figure class="highlight"><pre><code class="language-ruby" data-lang="ruby"><span class="c1"># File: app/controllers/base_controller.rb </span>
<span class="k">class</span> <span class="nc">BaseController</span> <span class="o">&lt;</span> <span class="no">ApplicationController</span>
    <span class="n">before_action</span> <span class="ss">:update_param</span><span class="p">,</span> <span class="ss">only: </span><span class="p">[</span><span class="ss">:create</span><span class="p">,</span><span class="ss">:update</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">update_param</span>
      <span class="n">params</span><span class="p">[</span><span class="n">extended_name</span><span class="p">][</span><span class="ss">:base_table</span><span class="p">]</span> <span class="o">=</span> <span class="n">params</span><span class="p">.</span><span class="nf">require</span><span class="p">(</span><span class="ss">:base_table</span><span class="p">).</span><span class="nf">permit</span><span class="p">(</span><span class="o">*</span><span class="n">base_table_properties</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="k">def</span> <span class="nf">base_table_properties</span>
      <span class="p">[</span><span class="ss">:name</span><span class="p">,</span> <span class="ss">:age</span><span class="p">]</span>
    <span class="k">end</span>
<span class="k">end</span></code></pre></figure>

<p>Up to this point, we’ve done model and controller part. Now let’s deal with the view.</p>

<p>Let’s create a common view for the base model:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># File: app/views/base_table/_form.html.slim
= fields_for base_form do |base_form|
  .field
    = base_form.label :name
    = base_form.text_field :name
  .field
    = base_form.label :age
    = base_form.number_field :age
</code></pre></div></div>

<p>Now, whenever we need the base_table in the view, we can simply do:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code># File: app/views/base_table/_form.html.slim 
= render 'base_table/form', base_form: @tennis_questionaire.base_table
</code></pre></div></div>

<p>and done. If one wants to add more common view into the <code class="language-plaintext highlighter-rouge">base_form</code>, one can simply add these codes into <code class="language-plaintext highlighter-rouge">app/views/base_table</code></p>

<p>I’ve created a demo-project to further illustrate the idea. Here’s the link: <a href="https://github.com/flyfy1/rails-mti-demo">https://github.com/flyfy1/rails-mti-demo</a></p>

<p>Further improvement on this mothod is to make it a gem.. it would then be (hopefully) easier to use.</p>

<p>Hopefully this helps someone :)</p>

  </div>

  <div class="ad-section">
    <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <!-- first-test -->
    <ins class="adsbygoogle"
         style="display:block"
         data-ad-client="ca-pub-4310544384247370"
         data-ad-slot="5532160063"
         data-ad-format="auto"></ins>
    <script>
      (adsbygoogle = window.adsbygoogle || []).push({});
    </script>
  </div>
</article>

<comments>
  

</comments>

      </div>
    </div>

    <footer class="site-footer">

  <div class="wrapper">

    <h2 class="footer-heading">Yangyu's Notes</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li>Yangyu's Notes</li>
          <li><a href="mailto:flyfy1@gmail.com">flyfy1@gmail.com</a></li>
        </ul>
      </div>

      <div class="footer-col footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a href="https://github.com/flyfy1"><span class="icon icon--github"><svg viewBox="0 0 16 16"><path fill="#828282" d="M7.999,0.431c-4.285,0-7.76,3.474-7.76,7.761 c0,3.428,2.223,6.337,5.307,7.363c0.388,0.071,0.53-0.168,0.53-0.374c0-0.184-0.007-0.672-0.01-1.32 c-2.159,0.469-2.614-1.04-2.614-1.04c-0.353-0.896-0.862-1.135-0.862-1.135c-0.705-0.481,0.053-0.472,0.053-0.472 c0.779,0.055,1.189,0.8,1.189,0.8c0.692,1.186,1.816,0.843,2.258,0.645c0.071-0.502,0.271-0.843,0.493-1.037 C4.86,11.425,3.049,10.76,3.049,7.786c0-0.847,0.302-1.54,0.799-2.082C3.768,5.507,3.501,4.718,3.924,3.65 c0,0,0.652-0.209,2.134,0.796C6.677,4.273,7.34,4.187,8,4.184c0.659,0.003,1.323,0.089,1.943,0.261 c1.482-1.004,2.132-0.796,2.132-0.796c0.423,1.068,0.157,1.857,0.077,2.054c0.497,0.542,0.798,1.235,0.798,2.082 c0,2.981-1.814,3.637-3.543,3.829c0.279,0.24,0.527,0.713,0.527,1.437c0,1.037-0.01,1.874-0.01,2.129 c0,0.208,0.14,0.449,0.534,0.373c3.081-1.028,5.302-3.935,5.302-7.362C15.76,3.906,12.285,0.431,7.999,0.431z"/></svg>
</span><span class="username">flyfy1</span></a>

          </li>
          

          
          <li>
            <a href="https://twitter.com/songyangyu"><span class="icon icon--twitter"><svg viewBox="0 0 16 16"><path fill="#828282" d="M15.969,3.058c-0.586,0.26-1.217,0.436-1.878,0.515c0.675-0.405,1.194-1.045,1.438-1.809c-0.632,0.375-1.332,0.647-2.076,0.793c-0.596-0.636-1.446-1.033-2.387-1.033c-1.806,0-3.27,1.464-3.27,3.27 c0,0.256,0.029,0.506,0.085,0.745C5.163,5.404,2.753,4.102,1.14,2.124C0.859,2.607,0.698,3.168,0.698,3.767 c0,1.134,0.577,2.135,1.455,2.722C1.616,6.472,1.112,6.325,0.671,6.08c0,0.014,0,0.027,0,0.041c0,1.584,1.127,2.906,2.623,3.206 C3.02,9.402,2.731,9.442,2.433,9.442c-0.211,0-0.416-0.021-0.615-0.059c0.416,1.299,1.624,2.245,3.055,2.271 c-1.119,0.877-2.529,1.4-4.061,1.4c-0.264,0-0.524-0.015-0.78-0.046c1.447,0.928,3.166,1.469,5.013,1.469 c6.015,0,9.304-4.983,9.304-9.304c0-0.142-0.003-0.283-0.009-0.423C14.976,4.29,15.531,3.714,15.969,3.058z"/></svg>
</span><span class="username">songyangyu</span></a>

          </li>
          
        </ul>
      </div>

      <div class="footer-col footer-col-3">
        <p>This is the ideas from Yangyu Song.
</p>
      </div>
    </div>

  </div>

</footer>


  </body>

</html>
